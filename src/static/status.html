<!doctype html>
<html lang="en">
<head>
    <meta charset="utf-8"/>
    <meta name="viewport" content="width=device-width, initial-scale=1"/>
    <title>Active Jobs</title>
    <style>
        body {
            font-family: system-ui, -apple-system, Segoe UI, Roboto, sans-serif;
            margin: 20px;
        }

        h1 {
            font-size: 1.25rem;
        }

        table {
            border-collapse: collapse;
            width: 100%;
            max-width: 900px;
        }

        th, td {
            border: 1px solid #ddd;
            padding: 8px;
        }

        th {
            background: #f5f5f5;
            text-align: left;
        }

        tr:nth-child(even) {
            background: #fafafa;
        }

        .status {
            text-transform: capitalize;
            font-weight: 600;
        }

        .bar {
            height: 10px;
            background: #eee;
            border-radius: 4px;
            overflow: hidden;
        }

        .bar > span {
            display: block;
            height: 100%;
            background: #4caf50;
        }

        .footer {
            color: #666;
            font-size: 12px;
            margin-top: 10px;
        }

        .section {
            margin-top: 28px;
        }

        code {
            white-space: nowrap;
        }

        .error {
            color: #b00020;
        }
    </style>
</head>
<body>
<h1>Active Jobs (processing, queued, webhook)</h1>
<div class="footer">Auto-updates every second</div>
<table>
    <thead>
    <tr>
        <th>#</th>
        <th>UUID</th>
        <th>Status</th>
        <th>Progress</th>
        <th>Completed At</th>
    </tr>
    </thead>
    <tbody id="rows">
    <tr>
        <td colspan="5">Loading…</td>
    </tr>
    </tbody>
</table>
<div class="footer" id="meta"></div>

<div class="section">
    <h1>Last 20 failed jobs</h1>
    <table>
        <thead>
        <tr>
            <th>#</th>
            <th>UUID</th>
            <th>Error</th>
        </tr>
        </thead>
        <tbody id="failedRows">
        <tr>
            <td colspan="3">Loading…</td>
        </tr>
        </tbody>
    </table>
    <div class="footer" id="metaFailed"></div>
</div>
<script>
    function escapeHtml(s) {
        return String(s == null ? '' : s)
            .replace(/&/g, '&amp;')
            .replace(/</g, '&lt;')
            .replace(/>/g, '&gt;')
            .replace(/"/g, '&quot;')
            .replace(/'/g, '&#39;');
    }

    async function refresh() {
        try {
            const [resActive, resFailed] = await Promise.all([
                fetch('/public/jobs.json', {cache: 'no-store'}),
                fetch('/public/failed-jobs.json', {cache: 'no-store'})
            ]);
            const data = await resActive.json();
            const failed = await resFailed.json();
            const tbody = document.getElementById('rows');
            if (!Array.isArray(data.jobs) || data.jobs.length === 0) {
                tbody.innerHTML = '<tr><td colspan="5">No active jobs</td></tr>';
            } else {
                tbody.innerHTML = data.jobs.map(function (j, idx) {
                    var pct = Math.round((Number(j.progress) || 0) * 100);
                    return '<tr>' +
                        '<td>' + (idx + 1) + '</td>' +
                        '<td><code>' + escapeHtml(j.uuid) + '</code></td>' +
                        '<td class="status">' + j.status + '</td>' +
                        '<td>' +
                        '<div class="bar"><span style="width:' + pct + '%;"></span></div>' +
                        '<div>' + pct + '%</div>' +
                        '</td>' +
                        '<td>' + (j.completed_at ? escapeHtml(j.completed_at) : '') + '</td>' +
                        '</tr>';
                }).join('');
            }
            const meta = document.getElementById('meta');
            meta.textContent = 'Last updated: ' + (data.updatedAt || new Date().toISOString());

            const tbodyFailed = document.getElementById('failedRows');
            if (!Array.isArray(failed.jobs) || failed.jobs.length === 0) {
                tbodyFailed.innerHTML = '<tr><td colspan="3">No failed jobs</td></tr>';
            } else {
                tbodyFailed.innerHTML = failed.jobs.map(function (j, idx) {
                    var err = escapeHtml(j.error || 'Unknown error');
                    return '<tr>' +
                        '<td>' + (idx + 1) + '</td>' +
                        '<td><code>' + escapeHtml(j.uuid) + '</code></td>' +
                        '<td class="error">' + err + '</td>' +
                        '</tr>';
                }).join('');
            }
            const metaFailed = document.getElementById('metaFailed');
            metaFailed.textContent = 'Last updated: ' + (failed.updatedAt || new Date().toISOString());
        } catch (e) {
            const tbody = document.getElementById('rows');
            tbody.innerHTML = '<tr><td colspan="5">Failed to load</td></tr>';
            const tbodyFailed = document.getElementById('failedRows');
            tbodyFailed.innerHTML = '<tr><td colspan="3">Failed to load</td></tr>';
        }
    }

    refresh();
    setInterval(refresh, 1000);
</script>
</body>
</html>
