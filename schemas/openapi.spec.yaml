openapi: 3.0.3
info:
  title: Async Automatic1111 Drop-in Replacement API with Civitai Metadata and Webhook Key
  version: 1.7.0
servers:
  - url: https://your-server.com
security:
  - bearerAuth: []
components:
  securitySchemes:
    bearerAuth:
      type: http
      scheme: bearer
      bearerFormat: "Token"
  schemas:
    JobUUIDResponse:
      type: object
      properties:
        uuid:
          type: string
          format: uuid
    JobSummary:
      type: object
      properties:
        uuid:
          type: string
          format: uuid
        job_status:
          type: string
          enum:
            - queued
            - processing
            - webhook
            - completed
            - error
            - canceled
        progress:
          type: number
          format: float
          minimum: 0
          maximum: 1
    JobProgressResponse:
      allOf:
        - $ref: '#/components/schemas/JobSummary'
        - type: object
          properties:
            images:
              type: array
              items:
                type: string
                description: Base64-encoded images (empty until complete)
            info:
              type: string
              nullable: true
              description: Additional info or error message
    ModelListResponse:
      type: object
      properties:
        models:
          type: array
          items:
            allOf:
              - type: object
                properties:
                  civitai:
                    type: object
                    nullable: true
                    description: Additional Civitai metadata object
    LoraListResponse:
      type: object
      properties:
        loras:
          type: array
          items:
            allOf:
              - type: object
                properties:
                  civitai:
                    type: object
                    nullable: true
                    description: Additional Civitai metadata object
    FlorenceRequest:
      type: object
      required: [ imageUrl, task ]
      properties:
        imageUrl:
          type: string
          format: uri
          description: Publicly accessible image URL to analyze
        mode:
          type: string
          enum: [ "Single task", "Cascaded task" ]
          description: Task mode to set in Florence UI. Defaults based on task.
          nullable: true
        task:
          type: string
          enum:
            - "More Detailed Caption + Grounding"
            - "Referring Expression Segmentation"
          description: Florence task to run
        prompt:
          type: string
          nullable: true
          description: Optional prompt (used for Referring Expression Segmentation). Leave empty for caption+grounding.
        webhookUrl:
          type: string
          format: uri
          nullable: true
          description: Optional webhook URL to receive job completion notification. When provided, the server sets job_status to "webhook" and only marks it "completed" after the webhook responds with a 2xx status.
        webhookKey:
          type: string
          nullable: true

paths:
  /sdapi/v1/txt2img:
    post:
      summary: Submit txt2img generation job (async)
      security:
        - bearerAuth: []
      requestBody:
        required: true
        content:
          application/json:
            schema:
              allOf:
                - $ref: './automatic1111.spec.json#/components/schemas/StableDiffusionProcessingTxt2Img'
                - type: object
                  properties:
                    webhookUrl:
                      type: string
                      format: uri
                      nullable: true
                      description: Optional webhook URL to receive job completion notification. When provided, the server sets job_status to "webhook" and only marks it "completed" after the webhook responds with a 2xx status.
                    webhookKey:
                      type: string
                      nullable: true
                      description: Optional secret key sent with webhook for authentication
      responses:
        '202':
          description: Job accepted; returns job UUID
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/JobUUIDResponse'

  /sdapi/v1/img2img:
    post:
      summary: Submit img2img generation job (async)
      security:
        - bearerAuth: []
      requestBody:
        required: true
        content:
          application/json:
            schema:
              allOf:
                - $ref: './automatic1111.spec.json#/components/schemas/StableDiffusionProcessingImg2Img'
                - type: object
                  properties:
                    webhookUrl:
                      type: string
                      format: uri
                      nullable: true
                      description: Optional webhook URL to receive job completion notification. When provided, the server sets job_status to "webhook" and only marks it "completed" after the webhook responds with a 2xx status.
                    webhookKey:
                      type: string
                      nullable: true
      responses:
        '202':
          description: Job accepted; returns job UUID
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/JobUUIDResponse'

  /sdapi/v1/jobs:
    get:
      summary: List active jobs (queued, processing, or webhook) with progress summary
      security:
        - bearerAuth: []
      responses:
        '200':
          description: List of active jobs (queued, processing, or webhook) and their progress. Jobs in "webhook" have finished generation and are awaiting a successful (2xx) webhook response before being marked as completed.
          content:
            application/json:
              schema:
                type: array
                items:
                  $ref: '#/components/schemas/JobSummary'

  /sdapi/v1/jobs/{uuid}:
    get:
      summary: Check detailed job progress and results
      security:
        - bearerAuth: []
      parameters:
        - in: path
          name: uuid
          required: true
          schema:
            type: string
            format: uuid
      responses:
        '200':
          description: Job progress data with images/base64 if completed
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/JobProgressResponse'
        '404':
          description: Job not found

    delete:
      summary: Cancel a queued or running job by UUID
      security:
        - bearerAuth: []
      parameters:
        - in: path
          name: uuid
          required: true
          schema:
            type: string
            format: uuid
      responses:
        '204':
          description: Job cancelled successfully
        '404':
          description: Job not found or already completed

  /sdapi/v1/sd-models:
    get:
      summary: Get list of available models/checkpoints
      security:
        - bearerAuth: []
      responses:
        '200':
          description: List of models with Civitai metadata if available
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/ModelListResponse'

  /sdapi/v1/sd-models/{modelId}:
    get:
      summary: Get details about a specific model/checkpoint (with Civitai metadata)
      security:
        - bearerAuth: []
      parameters:
        - in: path
          name: modelId
          required: true
          schema:
            type: string
      responses:
        '200':
          description: Model details
          content:
            application/json:
              schema:
                allOf:
                  - type: object
                    properties:
                      civitai:
                        type: object
                        nullable: true
                        description: Additional Civitai metadata object
        '404':
          description: Model not found

  /sdapi/v1/loras:
    get:
      summary: Get list of available LoRas
      security:
        - bearerAuth: []
      responses:
        '200':
          description: List of LoRas with Civitai metadata if available
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/LoraListResponse'

  /sdapi/v1/loras/{loraId}:
    get:
      summary: Get details about a specific LoRa (with Civitai metadata)
      security:
        - bearerAuth: []
      parameters:
        - in: path
          name: loraId
          required: true
          schema:
            type: string
      responses:
        '200':
          description: LoRa details
          content:
            application/json:
              schema:
                allOf:
                  - type: object
                    properties:
                      civitai:
                        type: object
                        nullable: true
                        description: Additional Civitai metadata object
        '404':
          description: LoRa not found

  /sdapi/v1/florence:
    post:
      summary: Submit a Florence-2 analysis job (async)
      description: |
        Queues a Florence-2 job that will call a backing Gradio app using two endpoints:
        1) POST /call/update_task_dropdown with the selected mode (Single or Cascaded task)
        2) POST /call/process_image with an image URL, the task name, prompt, and model "microsoft/Florence-2-large".

        Upon completion, the job result contains images[0] for the output image (if any) and info with the output text.
      security:
        - bearerAuth: []
      requestBody:
        required: true
        content:
          application/json:
            schema:
              $ref: '#/components/schemas/FlorenceRequest'
      responses:
        '202':
          description: Job accepted; returns job UUID
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/JobUUIDResponse'
