services:
  automatic-async-proxy:
    container_name: automatic-async-proxy
    build:
      context: .
      dockerfile: Dockerfile
    # If a local .env file exists at the repo root, docker compose will load it
    # automatically for variable interpolation AND we also pass it through to
    # the container as environment variables via env_file below.
    env_file:
      - .env
    environment:
      # Provide safe defaults; values from .env will override these.
      PORT: ${PORT:-3000}
    ports:
      - "${PORT:-3000}:${PORT:-3000}"
    volumes:
      - ./data:/data
    restart: unless-stopped

  worker:
    container_name: automatic-async-proxy-worker
    build:
      context: .
      dockerfile: Dockerfile
    env_file:
      - .env
    environment:
      WORKER_POLL_MS: ${WORKER_POLL_MS:-2000}
    depends_on:
      - automatic-async-proxy
    volumes:
      - ./data:/data
    command: ["yarn", "worker"]
    restart: unless-stopped
